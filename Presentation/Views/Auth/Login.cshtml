@model Application.DTOs.LoginRequest
@{
    ViewData["Title"] = "Login";
}

<div class="d-flex vh-100 align-items-center justify-content-center"
     style="background: url('/images/login-bg.JPG') no-repeat center center; background-size: cover;">
    <div class="bg-white bg-opacity-15 p-5 rounded-4 shadow" style="max-width: 450px; width: 110%;">

        <!-- Welcome message -->
        <p class="text-center fw-bold text-primary mb-2">Welcome back!</p>
        <!-- Logo / Title -->
        <h1 class="text-center text-primary mb-4 fw-semibold">Sign In</h1>

        <form asp-action="Login" method="post" novalidate id="loginForm">

            <!-- Username -->
            <div class="mb-3">
                <label asp-for="Email" class="form-label text-secondary">Username</label>
                <input asp-for="Email" class="form-control form-control-lg rounded-pill" placeholder="Insert username" required />
            </div>

            <!-- Password -->
            <div class="mb-3">
                <label asp-for="Password" class="form-label text-secondary">Password</label>
                <input asp-for="Password" type="password" class="form-control form-control-lg rounded-pill" placeholder="Insert password" required />
            </div>

            <!-- Forgot Password as a button to trigger modal -->
            <div class="float-end mb-3">
                <button type="button" class="btn btn-link text-primary" data-bs-toggle="modal" data-bs-target="#forgotPasswordModal">
                    Forgot Password?
                </button>
            </div>

            <!-- Remember Me -->
            <div class="form-check mb-4">
                <input asp-for="RememberMe" class="form-check-input" id="rememberMe" />
                <label asp-for="RememberMe" class="form-check-label text-secondary" for="rememberMe">Remember me</label>
            </div>

            <!-- Submit button -->
            <button type="submit" class="btn btn-primary btn-lg w-100 rounded-pill">Log in</button>

            @if (ViewBag.Error != null)
            {
                <div class="alert alert-danger mt-4" role="alert">@ViewBag.Error</div>
            }

        </form>
        <!-- Register link -->
        <p class="text-center mt-3">
            Don't have an account? <a asp-action="Register" class="text-primary">Register</a>
        </p>
    </div>

    <!-- Forgot Password Modal -->
    <div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-labelledby="forgotPasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-light rounded-4 shadow-lg">
                <div class="modal-header border-0">
                    <h5 class="modal-title text-primary" id="forgotPasswordModalLabel">Forgot Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="forgotPasswordForm" novalidate>
                        <div class="mb-3">
                            <label for="forgotEmail" class="form-label text-secondary">Enter your email</label>
                            <input type="email" id="forgotEmail" name="email" class="form-control rounded-pill" placeholder="you@example.com" required />
                        </div>
                        <button type="submit" class="btn btn-primary w-100 rounded-pill">Send Reset Link</button>
                    </form>
                    <div id="forgotMessage" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-light rounded-4 shadow-lg">
                <div class="modal-header border-0">
                    <h5 class="modal-title text-primary" id="resetPasswordModalLabel">Reset Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="resetPasswordForm" novalidate>
                        <input type="hidden" id="resetToken" name="token" />
                        <input type="hidden" id="resetEmail" name="email" />
                        <div class="mb-3">
                            <label for="resetPassword" class="form-label text-secondary">New Password</label>
                            <input type="password" id="resetPassword" name="password" class="form-control rounded-pill" required />
                        </div>
                        <div class="mb-3">
                            <label for="resetConfirmPassword" class="form-label text-secondary">Confirm Password</label>
                            <input type="password" id="resetConfirmPassword" name="confirmPassword" class="form-control rounded-pill" required />
                        </div>
                        <button type="submit" class="btn btn-primary w-100 rounded-pill">Reset</button>
                    </form>
                    <div id="resetMessage" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Forgot Password Form Submission
        document.getElementById('forgotPasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('forgotEmail').value;
            const response = await fetch('/Auth/ForgotPassword', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `email=${encodeURIComponent(email)}`
            });
            const data = await response.json();
            const messageDiv = document.getElementById('forgotMessage');
            if (data.success) {
                messageDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                setTimeout(() => $('#forgotPasswordModal').modal('hide'), 2000);
            } else {
                messageDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            }
        });

        // Handle Reset Password Link
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const email = urlParams.get('email');
            if (token && email) {
                document.getElementById('resetToken').value = token;
                document.getElementById('resetEmail').value = email;
                $('#resetPasswordModal').modal('show');
            }
        });

        // Reset Password Form Submission
        document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = document.getElementById('resetToken').value;
            const email = document.getElementById('resetEmail').value;
            const password = document.getElementById('resetPassword').value;
            const confirmPassword = document.getElementById('resetConfirmPassword').value;
            const response = await fetch('/Auth/ResetPassword', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `token=${encodeURIComponent(token)}&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}&confirmPassword=${encodeURIComponent(confirmPassword)}`
            });
            const data = await response.json();
            const messageDiv = document.getElementById('resetMessage');
            if (data.success) {
                messageDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                setTimeout(() => $('#resetPasswordModal').modal('hide'), 2000);
            } else {
                messageDiv.innerHTML = `<div class="alert alert-danger">${data.errors.join('<br>')}</div>`;
            }
        });
    </script>
}